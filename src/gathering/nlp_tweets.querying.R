#################################################################################################################################################################################################################################################################################
## Setup Environment ############################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

require(devtools); require(feather); require(tidyverse); load_all("~/CRYPTOSENT/src/packages/racademic/"); 

#################################################################################################################################################################################################################################################################################
## Globals ######################################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

portfolio <- data.frame(symbol = c("TRX", "XMR", "EOS", "CAKE", "DASH", 
                                   "BTC", "ETH", "XRP", "ADA", "DOT",
                                   "LTC", "UNI", "XLM", "NEO", "MIOTA"));

#################################################################################################################################################################################################################################################################################
## TWEETS & USERS DATA ##########################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

home.path <- "~/NLP/Project/data/original/"; for(i in portfolio$symbol) {
  
  rac.path = list.files(paste0(home.path, "/", i, "/")); 
  token = v2_aggregate_chunks(paste0(home.path, "/", i, "/", rac.path[grep("racademic", rac.path)], "/", "content/"));
  
  # TWEETS DATA;
  write_feather(data.frame(id         = sapply(token[["data"]], "[[", "id"),
                           text       = sapply(token[["data"]], "[[", "text"),
                           source     = sapply(token[["data"]], "[[", "source"),
                           created_at = sapply(token[["data"]], "[[", "created_at"),
                           author_id  = sapply(token[["data"]], "[[", "author_id")),
                paste0("~/NLP/Project/data/original/", i, "/", "tweets/tweets.feather"));
  
  # USERS DATA;
  write_feather(data.frame(name              = sapply(token[["includes"]][["users"]], "[[", "name"),
                           description       = sapply(token[["includes"]][["users"]], "[[", "description"),
                           id                = sapply(token[["includes"]][["users"]], "[[", "id"),
                           username          = sapply(token[["includes"]][["users"]], "[[", "username"),
                           url               = sapply(token[["includes"]][["users"]], "[[", "url"),
                           verified          = as.character(sapply(token[["includes"]][["users"]], "[[", "verified")),
                           location          = as.character(sapply(token[["includes"]][["users"]], "[[", "location")),
                           profile_image_url = sapply(token[["includes"]][["users"]], "[[", "profile_image_url"),
                           created_at        = sapply(token[["includes"]][["users"]], "[[", "created_at"),
                           protected         = as.character(sapply(token[["includes"]][["users"]], "[[", "protected")),
                           followers_count   = as.numeric(as.data.frame(t(as.data.frame(sapply(token[["includes"]][["users"]], "[[", "public_metrics"))))$followers_count),
                           following_count   = as.numeric(as.data.frame(t(as.data.frame(sapply(token[["includes"]][["users"]], "[[", "public_metrics"))))$following_count),
                           tweet_count       = as.numeric(as.data.frame(t(as.data.frame(sapply(token[["includes"]][["users"]], "[[", "public_metrics"))))$tweet_count),
                           listed_count      = as.numeric(as.data.frame(t(as.data.frame(sapply(token[["includes"]][["users"]], "[[", "public_metrics"))))$listed_count)),
                paste0("~/NLP/Project/data/original/", i, "/", "users/users.feather"));
}; rm(i, rac.path, home.path, token);

#################################################################################################################################################################################################################################################################################
## MERGING ######################################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

# TWEETS DATA;
tweets <- data.frame(); ntweets <- c(); home.path <- "~/NLP/Project/data/original/"; for(i in portfolio$symbol) {
  tweets = rbind(tweets, read_feather(paste0(home.path, "/", i, "/tweets/tweets.feather"))); ntweets = c(ntweets, nrow(tweets));
}; rm(i, home.path);
tweets$token <- NA; j <- 0; for(i in portfolio$symbol) {
  j = j + 1; tweets$token[(1 + ifelse(j == 1, 0, ntweets[j - 1])):ntweets[j]] = rep(i, diff(c(0, ntweets), lag = 1)[j]);
}; rm(i, j, ntweets); 

# USERS DATA;
users <- data.frame(); nusers <- c(); home.path <- "~/NLP/Project/data/original/"; for(i in portfolio$symbol) {
  users = rbind(users, read_feather(paste0(home.path, "/", i, "/users/users.feather"))); nusers = c(nusers, nrow(users));
}; rm(i, home.path, nusers);  

#################################################################################################################################################################################################################################################################################
## prices #######################################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

seq.days <- seq(strptime("2021-04-06T00:00:00Z", format = "%Y-%m-%dT%H:%M:%SZ"),
                strptime("2021-04-21T00:00:00Z", format = "%Y-%m-%dT%H:%M:%SZ"),
                by = "days")[-1];

classes <- data.frame(); for(i in portfolio$symbol) {
  classes = rbind(classes, data.frame(token   = rep(i, length(seq.days)),
                                      periods = seq.days));
}; rm(i); 

target = list(`TRX`   = c(0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0),
              `XMR`   = c(0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0),
              `EOS`   = c(0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0),
              `CAKE`  = c(0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0), # USD;
              `DASH`  = c(0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0),
              `BTC`   = c(0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0),
              `ETH`   = c(0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1),
              `XRP`   = c(0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0),
              `ADA`   = c(0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0),
              `DOT`   = c(0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0),
              `LTC`   = c(0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0),
              `UNI`   = c(0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 1),
              `XLM`   = c(0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0),
              `MIOTA` = c(0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0),
              `NEO`   = c(0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0));

for(i in 1:length(target)) {classes$target[which(classes$token == names(target[i]))] = target[i][[1]];}; 
rm(i, seq.days, target, portfolio);

#################################################################################################################################################################################################################################################################################
## users ########################################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

users <- users[!duplicated(users[, "id"]),]; colnames(users)[grep("created_at", colnames(users))] <- "account_created_at";
users$bot <- 0; users[which(grepl("bot", users$name, fixed = TRUE) + grepl("bot", users$username, fixed = TRUE) >= 1), "bot"] = 1;
write_feather(users, "~/NLP/Project/data/eda/users.feather");

#################################################################################################################################################################################################################################################################################
## tweets #######################################################################################################################################################################################################################################################################
#################################################################################################################################################################################################################################################################################

tweets <- tweets[!duplicated(tweets[, "id"]),]; tweets <- left_join(tweets, users, by = c("author_id" = "id"));
tweets$created_at <- as.POSIXct(tweets$created_at, format = "%Y-%m-%dT%H:%M:%S.000Z");

tweets$target = NA; for(i in 1:nrow(classes)) {
  tweets$target[which(tweets$token == classes$token[i] & tweets$created_at < classes$periods[i] & is.na(tweets$target))] = classes$target[i];
}; rm(i); 
tweets$train <- 0; tweets$train[which(tweets$created_at < strptime("2021-04-06T00:00:00Z", format = "%Y-%m-%dT%H:%M:%SZ") + 60 * 60 * 24 * 7 )] <- 1;
write_feather(tweets, "~/NLP/Project/data/eda/tweets.feather");
write.csv(tweets, "~/NLP/Project/data/eda/tweets.csv", row.names = FALSE); rm(classes, tweets, users);